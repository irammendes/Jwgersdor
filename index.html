<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Avançado Lotofácil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
            gap: 15px;
        }

        h1, h2, h3 {
            color: var(--primary);
            margin: 0 0 15px 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .card {
            background: var(--white);
            border-left: 4px solid var(--success);
            margin-bottom: 25px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .number {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .number.selected {
            background: var(--success);
            color: white;
            transform: scale(1.1);
        }

        .number:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .game-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .game-number {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
        }

        .missing {
            background: var(--danger);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--warning);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--secondary);
        }

        .stat-card h4 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
        }

        .stat-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        .info {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 4px solid var(--secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-magic"></i> Gerador Avançado Lotofácil</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Atualizar Dados
                </button>
                <button class="btn" id="generateBtn">
                    <i class="fas fa-dice"></i> Gerar Jogos
                </button>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="grid">
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> Configurações</h2>
                
                <div class="control-group">
                    <label for="gameQuantity"><i class="fas fa-list-ol"></i> Quantidade de jogos:</label>
                    <select id="gameQuantity">
                        <option value="1">1 jogo</option>
                        <option value="3">3 jogos</option>
                        <option value="5" selected>5 jogos</option>
                        <option value="10">10 jogos</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="lastGames"><i class="fas fa-history"></i> Concursos analisados:</label>
                    <select id="lastGames">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="missingRange"><i class="fas fa-chart-line"></i> Dezenas faltantes por jogo:</label>
                    <select id="missingRange">
                        <option value="2-4">2-4</option>
                        <option value="3-5" selected>3-5</option>
                        <option value="4-6">4-6</option>
                        <option value="5-7">5-7</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="maxLastDraw"><i class="fas fa-sync"></i> Máx. dezenas do último sorteio:</label>
                    <select id="maxLastDraw">
                        <option value="15">Sem limite</option>
                        <option value="12">12</option>
                        <option value="10" selected>10</option>
                        <option value="8">8</option>
                        <option value="6">6</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="balanceMode"><i class="fas fa-equals"></i> Balancear pares/ímpares:</label>
                    <select id="balanceMode">
                        <option value="none">Não verificar</option>
                        <option value="normal" selected>Sim (entre 6 e 9)</option>
                        <option value="strict">Estrito (7 ou 8)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-filter"></i> Filtros</h2>
                
                <div class="control-group">
                    <label for="fixedNumbers"><i class="fas fa-thumbtack"></i> Fixar dezenas:</label>
                    <input type="text" id="fixedNumbers" placeholder="Ex: 3,7,15">
                    <small>Estas dezenas aparecerão em todos os jogos</small>
                </div>

                <div class="control-group">
                    <label for="excludedNumbers"><i class="fas fa-ban"></i> Excluir dezenas:</label>
                    <input type="text" id="excludedNumbers" placeholder="Ex: 5,10,24">
                    <small>Estas dezenas não aparecerão em nenhum jogo</small>
                </div>

                <h3><i class="fas fa-mouse-pointer"></i> Seletor de Números</h3>
                <p>Clique nos números para fixá-los:</p>
                <div class="number-grid" id="numberGrid"></div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-chart-bar"></i> Estatísticas Atuais</h2>
            
            <div id="lastDrawInfo">
                <p><i class="fas fa-spinner fa-spin"></i> Carregando dados do último sorteio...</p>
            </div>
            
            <div class="stats-grid" id="statsContainer">
                <div class="stat-card">
                    <h4><i class="fas fa-fire"></i> Dezenas Quentes</h4>
                    <div id="hotNumbers"></div>
                </div>
                
                <div class="stat-card">
                    <h4><i class="fas fa-snowflake"></i> Dezenas Frias</h4>
                    <div id="coldNumbers"></div>
                </div>
                
                <div class="stat-card">
                    <h4><i class="fas fa-clock"></i> Dezenas Atrasadas</h4>
                    <div id="delayedNumbers"></div>
                </div>
                
                <div class="stat-card">
                    <h4><i class="fas fa-redo"></i> Sequências</h4>
                    <div id="sequenceInfo"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="frequencyChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-dice"></i> Jogos Gerados</h2>
            <div id="resultsContainer">
                <p style="text-align: center;"><i class="fas fa-info-circle"></i> Clique em "Gerar Jogos" para criar seus jogos estratégicos.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const elements = {
                // Botões
                generateBtn: document.getElementById('generateBtn'),
                refreshBtn: document.getElementById('refreshBtn'),
                
                // Inputs
                gameQuantity: document.getElementById('gameQuantity'),
                lastGames: document.getElementById('lastGames'),
                missingRange: document.getElementById('missingRange'),
                maxLastDraw: document.getElementById('maxLastDraw'),
                balanceMode: document.getElementById('balanceMode'),
                fixedNumbers: document.getElementById('fixedNumbers'),
                excludedNumbers: document.getElementById('excludedNumbers'),
                
                // Containers
                statusMessage: document.getElementById('statusMessage'),
                numberGrid: document.getElementById('numberGrid'),
                resultsContainer: document.getElementById('resultsContainer'),
                lastDrawInfo: document.getElementById('lastDrawInfo'),
                statsContainer: document.getElementById('statsContainer'),
                hotNumbers: document.getElementById('hotNumbers'),
                coldNumbers: document.getElementById('coldNumbers'),
                delayedNumbers: document.getElementById('delayedNumbers'),
                sequenceInfo: document.getElementById('sequenceInfo')
            };

            // Estado da aplicação
            const state = {
                resultados: [],
                isLoading: false,
                generatedGames: [],
                lastUpdateAttempt: 0,
                dataSource: null,
                frequencyChart: null
            };

            // Constantes
            const constants = {
                CACHE_KEY: 'lotofacil_advanced_cache',
                CACHE_EXPIRATION: 6 * 60 * 60 * 1000, // 6 horas
                MIN_GAMES: 5
            };

            // Inicialização
            initNumberGrid();
            loadData();
            setupEventListeners();

            function initNumberGrid() {
                elements.numberGrid.innerHTML = '';
                for (let i = 1; i <= 25; i++) {
                    const numElement = document.createElement('div');
                    numElement.className = 'number';
                    numElement.textContent = i.toString().padStart(2, '0');
                    numElement.dataset.number = i;
                    numElement.addEventListener('click', toggleNumberSelection);
                    elements.numberGrid.appendChild(numElement);
                }
            }

            function toggleNumberSelection(e) {
                e.target.classList.toggle('selected');
                updateFixedNumbers();
            }

            function updateFixedNumbers() {
                const selected = Array.from(document.querySelectorAll('.number.selected'))
                    .map(el => parseInt(el.dataset.number));
                elements.fixedNumbers.value = selected.join(',');
            }

            function setupEventListeners() {
                // Botões
                elements.generateBtn.addEventListener('click', handleGenerateClick);
                elements.refreshBtn.addEventListener('click', handleRefreshClick);
                
                // Inputs
                elements.fixedNumbers.addEventListener('input', function() {
                    updateNumberGridSelection(validateNumberInput(this.value));
                });
                
                elements.fixedNumbers.addEventListener('change', function() {
                    updateNumberGridSelection(validateNumberInput(this.value));
                });
            }

            function handleGenerateClick() {
                if (state.isLoading) {
                    showStatus('Aguarde, os dados estão sendo carregados...', 'warning');
                    return;
                }
                
                if (state.resultados.length === 0) {
                    showStatus('Nenhum dado disponível. Atualize os dados primeiro.', 'error');
                    elements.refreshBtn.focus();
                    return;
                }
                
                generateGames();
            }

            function handleRefreshClick() {
                const now = Date.now();
                if (state.isLoading) {
                    showStatus('Já está atualizando, aguarde...', 'warning');
                    return;
                }
                
                if (now - state.lastUpdateAttempt < 10000) {
                    const secondsLeft = Math.ceil((10000 - (now - state.lastUpdateAttempt)) / 1000);
                    showStatus(`Aguarde ${secondsLeft} segundos antes de atualizar novamente`, 'warning');
                    return;
                }
                
                state.lastUpdateAttempt = now;
                loadData();
            }

            function validateNumberInput(input) {
                if (!input.trim()) return [];
                
                return input.split(',')
                    .map(n => parseInt(n.trim()))
                    .filter(n => !isNaN(n) && n >= 1 && n <= 25)
                    .filter((n, i, arr) => arr.indexOf(n) === i); // Remove duplicatas
            }

            function updateNumberGridSelection(numbers) {
                document.querySelectorAll('.number').forEach(el => {
                    const num = parseInt(el.dataset.number);
                    el.classList.toggle('selected', numbers.includes(num));
                });
            }

            async function loadData() {
                if (state.isLoading) return;
                
                state.isLoading = true;
                updateButtonStates();
                showStatus('Conectando ao servidor de resultados...', 'info');
                
                try {
                    // Tentar primeiro o cache local
                    const cachedData = getCachedData();
                    if (cachedData && cachedData.length >= constants.MIN_GAMES) {
                        state.resultados = cachedData;
                        state.dataSource = 'cache';
                        showStatus('Dados carregados do cache (offline)', 'warning');
                        processResults();
                        return;
                    }
                    
                    // Tentar APIs
                    const apiResponse = await tryCaixaAPI() || await tryBrasilAPI();
                    
                    if (apiResponse) {
                        processData(apiResponse);
                        cacheData(state.resultados);
                        showStatus('Dados atualizados com sucesso!', 'success');
                    } else {
                        useSampleData();
                        showStatus('Usando dados de exemplo. Atualize mais tarde.', 'warning');
                    }
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    const cachedData = getCachedData();
                    if (cachedData && cachedData.length >= constants.MIN_GAMES) {
                        state.resultados = cachedData;
                        state.dataSource = 'cache';
                        showStatus('Usando dados do cache devido a erro na conexão', 'warning');
                    } else {
                        useSampleData();
                        showStatus('Falha na conexão. Usando dados de exemplo.', 'error');
                    }
                } finally {
                    state.isLoading = false;
                    updateButtonStates();
                    processResults();
                }
            }

            // API da Caixa Econômica
            async function tryCaixaAPI() {
                try {
                    // Usando proxy CORS para evitar bloqueios
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const apiUrl = 'https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil';
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(apiUrl), {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) throw new Error('API Caixa não respondeu');
                    
                    const data = await response.json();
                    state.dataSource = 'caixa';
                    
                    // Formatar dados da Caixa
                    const formattedData = Array.isArray(data) ? data : [data];
                    return formattedData.map(item => ({
                        concurso: item.numero,
                        data: item.dataApuracao,
                        numeros: item.listaDezenas.map(Number).sort((a, b) => a - b)
                    }));
                } catch (error) {
                    console.log("API Caixa falhou:", error);
                    return null;
                }
            }

            // API BrasilAPI (fallback)
            async function tryBrasilAPI() {
                try {
                    const response = await fetch('https://brasilapi.com.br/api/loteria/v1/lotofacil');
                    if (!response.ok) throw new Error('BrasilAPI não respondeu');
                    
                    const data = await response.json();
                    state.dataSource = 'brasilapi';
                    
                    // Formatar dados da BrasilAPI
                    return data.concursos.map(concurso => ({
                        concurso: concurso.numero,
                        data: concurso.data,
                        numeros: concurso.dezenas.map(Number).sort((a, b) => a - b)
                    })).sort((a, b) => b.concurso - a.concurso); // Ordenar do mais recente
                } catch (error) {
                    console.log("BrasilAPI falhou:", error);
                    return null;
                }
            }

            function getCachedData() {
                const cached = localStorage.getItem(constants.CACHE_KEY);
                if (!cached) return null;
                
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    
                    if (Date.now() - timestamp > constants.CACHE_EXPIRATION) {
                        return null;
                    }
                    
                    return data;
                } catch (e) {
                    return null;
                }
            }

            function cacheData(data) {
                try {
                    const cache = {
                        data: data,
                        timestamp: Date.now(),
                        source: state.dataSource
                    };
                    localStorage.setItem(constants.CACHE_KEY, JSON.stringify(cache));
                } catch (e) {
                    console.error("Erro ao salvar cache:", e);
                }
            }

            function processData(data) {
                try {
                    if (!Array.isArray(data)) {
                        throw new Error("Dados não são um array");
                    }
                    
                    // Ordenar por concurso (mais recente primeiro)
                    state.resultados = data.sort((a, b) => b.concurso - a.concurso);
                    
                    // Garantir mínimo de resultados
                    if (state.resultados.length < constants.MIN_GAMES) {
                        const missing = constants.MIN_GAMES - state.resultados.length;
                        for (let i = 0; i < missing; i++) {
                            state.resultados.push(generateSampleResult(state.resultados[0].concurso - (i + 1)));
                        }
                    }
                } catch (e) {
                    console.error("Erro ao processar dados:", e);
                    useSampleData();
                }
            }

            function generateSampleResult(concurso) {
                // Gerar números aleatórios para exemplo
                const nums = [];
                while (nums.length < 15) {
                    const num = Math.floor(Math.random() * 25) + 1;
                    if (!nums.includes(num)) nums.push(num);
                }
                
                return {
                    concurso: concurso,
                    data: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString(),
                    numeros: nums.sort((a, b) => a - b)
                };
            }

            function useSampleData() {
                state.resultados = [
                    { concurso: 2900, data: "01/04/2025", numeros: [1, 2, 3, 5, 8, 9, 12, 14, 16, 18, 20, 21, 23, 24, 25] },
                    { concurso: 2899, data: "30/03/2025", numeros: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 22, 23, 24, 25, 10] },
                    { concurso: 2898, data: "27/03/2025", numeros: [2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 1, 3, 5] },
                    { concurso: 2897, data: "25/03/2025", numeros: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 2, 4] },
                    { concurso: 2896, data: "23/03/2025", numeros: [5, 10, 15, 20, 25, 4, 9, 14, 19, 24, 3, 8, 13, 18, 23] }
                ];
                
                state.dataSource = 'exemplo';
            }

            function updateButtonStates() {
                elements.generateBtn.disabled = state.isLoading || state.resultados.length === 0;
                elements.refreshBtn.disabled = state.isLoading;
                
                if (state.isLoading) {
                    elements.generateBtn.innerHTML = '<span class="loading"></span> Aguarde...';
                    elements.refreshBtn.innerHTML = '<span class="loading"></span> Atualizando...';
                } else {
                    elements.generateBtn.innerHTML = '<i class="fas fa-dice"></i> Gerar Jogos';
                    elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar Dados';
                }
            }

            function processResults() {
                if (state.resultados.length === 0) return;
                
                updateLastDrawInfo();
                updateStatistics();
                updateCharts();
                
                showStatus(`Dados carregados: ${getDataSourceName()}`, 'info');
            }

            function getDataSourceName() {
                switch(state.dataSource) {
                    case 'caixa': return 'Caixa Econômica';
                    case 'brasilapi': return 'BrasilAPI';
                    case 'cache': return 'Cache Local';
                    case 'exemplo': return 'Dados de Exemplo';
                    default: return 'Fonte Desconhecida';
                }
            }

            function updateLastDrawInfo() {
                const last = state.resultados[0];
                elements.lastDrawInfo.innerHTML = `
                    <h3><i class="fas fa-trophy"></i> Último Sorteio</h3>
                    <p><strong>Concurso:</strong> ${last.concurso} (${last.data})</p>
                    <div class="game-numbers">
                        ${last.numeros.map(n => `<span class="game-number">${n.toString().padStart(2, '0')}</span>`).join('')}
                    </div>
                `;
            }

            function updateStatistics() {
                // Calcular frequências
                const todas = state.resultados.flatMap(r => r.numeros);
                const contagem = {};
                for (let i = 1; i <= 25; i++) contagem[i] = 0;
                todas.forEach(n => contagem[n]++);
                
                // Ordenar por frequência
                const sorted = Object.entries(contagem).sort((a, b) => b[1] - a[1]);
                
                // Dezenas quentes (top 5)
                elements.hotNumbers.innerHTML = sorted.slice(0, 5)
                    .map(([n, c]) => `<div class="stat-item">
                        <span>${n.padStart(2, '0')}</span>
                        <span>${c}x</span>
                    </div>`).join('');
                
                // Dezenas frias (bottom 5)
                elements.coldNumbers.innerHTML = sorted.slice(-5).reverse()
                    .map(([n, c]) => `<div class="stat-item">
                        <span>${n.padStart(2, '0')}</span>
                        <span>${c}x</span>
                    </div>`).join('');
                
                // Calcular atrasos
                const atrasos = {};
                for (let i = 1; i <= 25; i++) atrasos[i] = 0;
                
                for (const resultado of state.resultados) {
                    for (let i = 1; i <= 25; i++) {
                        if (resultado.numeros.includes(i)) {
                            atrasos[i] = 0;
                        } else {
                            atrasos[i]++;
                        }
                    }
                }
                
                // Dezenas mais atrasadas
                const atrasadas = Object.entries(atrasos).sort((a, b) => b[1] - a[1]).slice(0, 5);
                elements.delayedNumbers.innerHTML = atrasadas
                    .map(([n, a]) => `<div class="stat-item">
                        <span>${n.padStart(2, '0')}</span>
                        <span>${a} concursos</span>
                    </div>`).join('');
                
                // Sequências (presença/ausência)
                const sequencias = {};
                for (let i = 1; i <= 25; i++) {
                    sequencias[i] = { presente: 0, ausente: 0 };
                }
                
                let currentStatus = {};
                for (let i = 1; i <= 25; i++) {
                    currentStatus[i] = state.resultados[0].numeros.includes(i) ? 'presente' : 'ausente';
                }
                
                for (const resultado of state.resultados) {
                    for (let i = 1; i <= 25; i++) {
                        if (resultado.numeros.includes(i)) {
                            if (currentStatus[i] === 'presente') {
                                sequencias[i].presente++;
                            } else {
                                currentStatus[i] = 'presente';
                                sequencias[i].presente = 1;
                            }
                        } else {
                            if (currentStatus[i] === 'ausente') {
                                sequencias[i].ausente++;
                            } else {
                                currentStatus[i] = 'ausente';
                                sequencias[i].ausente = 1;
                            }
                        }
                    }
                }
                
                // Mostrar sequências interessantes
                const sequenciasPresentes = Object.entries(sequencias)
                    .filter(([_, s]) => s.presente >= 3)
                    .sort((a, b) => b[1].presente - a[1].presente);
                
                const sequenciasAusentes = Object.entries(sequencias)
                    .filter(([_, s]) => s.ausente >= 3)
                    .sort((a, b) => b[1].ausente - a[1].ausente);
                
                let sequenciasHTML = '';
                
                if (sequenciasPresentes.length > 0) {
                    sequenciasHTML += '<p><strong>Presentes há vários concursos:</strong></p>';
                    sequenciasHTML += sequenciasPresentes.slice(0, 3)
                        .map(([n, s]) => `<span class="badge">${n.padStart(2, '0')} (${s.presente} concursos)</span>`)
                        .join('');
                }
                
                if (sequenciasAusentes.length > 0) {
                    sequenciasHTML += '<p style="margin-top: 10px;"><strong>Ausentes há vários concursos:</strong></p>';
                    sequenciasHTML += sequenciasAusentes.slice(0, 3)
                        .map(([n, s]) => `<span class="badge">${n.padStart(2, '0')} (${s.ausente} concursos)</span>`)
                        .join('');
                }
                
                elements.sequenceInfo.innerHTML = sequenciasHTML || '<p>Nenhuma sequência significativa encontrada.</p>';
            }

            function updateCharts() {
                if (state.resultados.length === 0) return;
                
                // Dados para gráfico de frequência
                const todas = state.resultados.flatMap(r => r.numeros);
                const contagem = {};
                for (let i = 1; i <= 25; i++) contagem[i] = 0;
                todas.forEach(n => contagem[n]++);
                
                // Configuração do gráfico
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frequência'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Dezenas'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Frequência: ${context.raw}`;
                                }
                            }
                        }
                    }
                };
                
                // Destruir gráfico anterior se existir
                if (state.frequencyChart) {
                    state.frequencyChart.destroy();
                }
                
                // Criar novo gráfico
                const ctx = document.getElementById('frequencyChart').getContext('2d');
                state.frequencyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(contagem).map(n => n.padStart(2, '0')),
                        datasets: [{
                            data: Object.values(contagem),
                            backgroundColor: Array.from({length: 25}, (_, i) => {
                                const value = Object.values(contagem)[i];
                                const max = Math.max(...Object.values(contagem));
                                const ratio = value / max;
                                
                                if (ratio > 0.8) return 'rgba(231, 76, 60, 0.7)'; // Vermelho para as mais frequentes
                                if (ratio < 0.3) return 'rgba(46, 204, 113, 0.7)'; // Verde para as menos frequentes
                                return 'rgba(52, 152, 219, 0.7)'; // Azul para as intermediárias
                            }),
                            borderColor: Array.from({length: 25}, (_, i) => {
                                const value = Object.values(contagem)[i];
                                const max = Math.max(...Object.values(contagem));
                                const ratio = value / max;
                                
                                if (ratio > 0.8) return 'rgba(231, 76, 60, 1)';
                                if (ratio < 0.3) return 'rgba(46, 204, 113, 1)';
                                return 'rgba(52, 152, 219, 1)';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: chartOptions
                });
            }

            function generateGames() {
                if (state.isLoading) return;
                
                const quantity = parseInt(elements.gameQuantity.value);
                const [minMissing, maxMissing] = elements.missingRange.value.split('-').map(Number);
                const lastGames = parseInt(elements.lastGames.value);
                const fixedNumbers = validateNumberInput(elements.fixedNumbers.value.trim());
                const excludedNumbers = validateNumberInput(elements.excludedNumbers.value.trim());
                const maxLastDrawAllowed = parseInt(elements.maxLastDraw.value);
                const balanceMode = elements.balanceMode.value;
                
                // Validar inputs
                if (fixedNumbers.length > 15) {
                    showStatus('Você pode fixar no máximo 15 números.', 'error');
                    return;
                }
                
                if (excludedNumbers.length > 20) {
                    showStatus('Você pode excluir no máximo 20 números.', 'error');
                    return;
                }
                
                if (fixedNumbers.some(n => excludedNumbers.includes(n))) {
                    showStatus('Você não pode fixar e excluir a mesma dezena.', 'error');
                    return;
                }
                
                elements.generateBtn.innerHTML = '<span class="loading"></span> Gerando...';
                elements.generateBtn.disabled = true;
                
                // Processamento assíncrono
                setTimeout(() => {
                    try {
                        const missingNumbers = getMissingNumbers(lastGames).filter(n => !excludedNumbers.includes(n));
                        state.generatedGames = [];
                        
                        for (let i = 0; i < quantity; i++) {
                            let tentativa = 0;
                            let game;
                            
                            do {
                                game = generateGame(missingNumbers, minMissing, maxMissing, fixedNumbers);
                                tentativa++;
                                
                                // Verificar limite de dezenas do último sorteio
                                const lastResult = state.resultados[0].numeros;
                                const countLast = game.numbers.filter(n => lastResult.includes(n)).length;
                                
                                // Verificar balanceamento pares/ímpares
                                const isBalanced = checkBalance(game.numbers, balanceMode);
                                
                                if (countLast <= maxLastDrawAllowed && isBalanced) break;
                            } while (tentativa < 100);
                            
                            state.generatedGames.push(game);
                        }
                        
                        displayResults();
                        showStatus(`${quantity} jogos gerados com sucesso!`, 'success');
                    } catch (error) {
                        console.error("Erro ao gerar jogos:", error);
                        showStatus('Erro ao gerar jogos. Tente novamente.', 'error');
                    } finally {
                        elements.generateBtn.innerHTML = '<i class="fas fa-dice"></i> Gerar Jogos';
                        elements.generateBtn.disabled = false;
                    }
                }, 100);
            }

            function getMissingNumbers(lastGames) {
                const recentResults = state.resultados.slice(0, lastGames);
                const drawnNumbers = new Set();
                
                recentResults.forEach(result => {
                    result.numeros.forEach(num => drawnNumbers.add(num));
                });
                
                return Array.from({length: 25}, (_, i) => i + 1)
                    .filter(num => !drawnNumbers.has(num));
            }

            function generateGame(missingNumbers, minMissing, maxMissing, fixedNumbers) {
                // Quantidade de dezenas faltantes (aleatória dentro do intervalo)
                const missingCount = Math.floor(Math.random() * (maxMissing - minMissing + 1)) + minMissing;
                const selectedMissing = shuffleArray([...missingNumbers]).slice(0, missingCount);
                
                // Dezenas que apareceram recentemente (exceto fixas e excluídas)
                const regularNumbers = Array.from({length: 25}, (_, i) => i + 1)
                    .filter(n => !missingNumbers.includes(n) && !fixedNumbers.includes(n));
                
                // Quantidade de dezenas regulares necessárias
                const regularCount = 15 - selectedMissing.length - fixedNumbers.length;
                const selectedRegular = shuffleArray(regularNumbers).slice(0, regularCount);
                
                return {
                    numbers: [...fixedNumbers, ...selectedMissing, ...selectedRegular].sort((a, b) => a - b),
                    missing: selectedMissing,
                    date: new Date().toLocaleString()
                };
            }

            function checkBalance(numbers, mode) {
                const pares = numbers.filter(n => n % 2 === 0).length;
                
                if (mode === 'none') return true;
                if (mode === 'normal') return pares >= 6 && pares <= 9;
                if (mode === 'strict') return pares === 7 || pares === 8;
                
                return false;
            }

            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            function displayResults() {
                if (state.generatedGames.length === 0) {
                    elements.resultsContainer.innerHTML = '<p style="text-align: center;">Nenhum jogo foi gerado.</p>';
                    return;
                }
                
                const missingNumbers = getMissingNumbers(parseInt(elements.lastGames.value))
                    .filter(n => !validateNumberInput(elements.excludedNumbers.value.trim()).includes(n));
                
                let html = '';
                
                state.generatedGames.forEach((game, index) => {
                    const pares = game.numbers.filter(n => n % 2 === 0).length;
                    const impares = 15 - pares;
                    const sum = game.numbers.reduce((a, b) => a + b, 0);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px;">
                            <div class="game-header">
                                <h3>Jogo ${index + 1}</h3>
                                <div style="display: flex; gap: 8px;">
                                    <span class="badge">${game.missing.length} faltantes</span>
                                    <span class="badge" style="background: var(--primary)">${pares}P ${impares}I</span>
                                </div>
                            </div>
                            <div class="game-numbers">
                                ${game.numbers.map(num => `
                                    <span class="game-number ${game.missing.includes(num) ? 'missing' : ''}" 
                                        title="${game.missing.includes(num) ? 'Dezena faltante' : 'Dezena recente'}">
                                        ${num.toString().padStart(2, '0')}
                                    </span>
                                `).join('')}
                            </div>
                            <p><small>Soma: ${sum} | Dezenas: ${game.numbers.join(', ')}</small></p>
                        </div>
                    `;
                });
                
                // Adicionar info sobre dezenas faltantes
                html = `
                    <div class="card" style="margin-bottom: 20px; background-color: var(--light);">
                        <h3><i class="fas fa-info-circle"></i> Dezenas Faltantes</h3>
                        <p>Estas dezenas não apareceram nos últimos ${elements.lastGames.value} concursos:</p>
                        <div class="game-numbers">
                            ${missingNumbers.length > 0 ? 
                                missingNumbers.map(n => `<span class="game-number missing">${n.toString().padStart(2, '0')}</span>`).join('') : 
                                '<p>Todas as dezenas apareceram nos últimos concursos</p>'}
                        </div>
                        <p>Total: ${missingNumbers.length} dezenas não sorteadas recentemente</p>
                    </div>
                    ${html}
                `;
                
                elements.resultsContainer.innerHTML = html;
            }

            function showStatus(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <i class="fas fa-${getIconForType(type)}"></i>
                    <span>${message}</span>
                `;
                
                // Limpar mensagens anteriores
                while (elements.statusMessage.firstChild) {
                    elements.statusMessage.removeChild(elements.statusMessage.firstChild);
                }
                
                elements.statusMessage.appendChild(messageDiv);
                
                // Remove mensagem após 5 segundos (exceto erros)
                if (type !== 'error') {
                    setTimeout(() => {
                        if (elements.statusMessage.contains(messageDiv)) {
                            elements.statusMessage.removeChild(messageDiv);
                        }
                    }, 5000);
                }
            }

            function getIconForType(type) {
                switch(type) {
                    case 'error': return 'times-circle';
                    case 'success': return 'check-circle';
                    case 'warning': return 'exclamation-triangle';
                    default: return 'info-circle';
                }
            }
        });
    </script>
</body>
</html>
