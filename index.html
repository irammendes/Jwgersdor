<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Estratégico Lotofácil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --white: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
            gap: 15px;
        }

        h1 {
            font-size: 24px;
            margin: 0;
            color: var(--primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }

        .game-card {
            background: var(--white);
            border-left: 4px solid var(--success);
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .game-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .game-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .numero {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
        }

        .missing {
            background: var(--danger);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .control-group {
            flex: 1 1 250px;
            min-width: 200px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--warning);
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            color: white;
        }

        .missing-list {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .grid-number {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
            user-select: none;
        }

        .grid-number.selected {
            background: var(--success);
            color: white;
            transform: scale(1.1);
        }

        .grid-number:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            position: relative;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(0,0,0,0.05);
        }

        .tab.active {
            border-bottom-color: var(--secondary);
            font-weight: bold;
            color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content.active {
            display: block;
        }

        .save-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .saved-games {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .saved-game {
            background: var(--light);
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        .saved-game:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .saved-game-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-message {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .warning-message {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        .info-message {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            border-left: 4px solid var(--secondary);
        }

        #statusMessage {
            margin: 15px 0;
        }

        @media(max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                flex: 1 1 100%;
            }
            
            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-magic"></i> Gerador Estratégico Lotofácil</h1>
            <div style="display: flex; gap: 10px;">
                <button class="btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Atualizar Dados
                </button>
                <button class="btn" id="generateBtn">
                    <i class="fas fa-dice"></i> Gerar Jogos
                </button>
            </div>
        </div>

        <p style="margin-bottom: 20px;">Gere jogos otimizados com base nas estatísticas dos últimos concursos da Lotofácil.</p>

        <div class="controls">
            <div class="control-group">
                <label for="gameQuantity"><i class="fas fa-list-ol"></i> Quantidade de jogos:</label>
                <select id="gameQuantity">
                    <option value="1">1 jogo</option>
                    <option value="3">3 jogos</option>
                    <option value="5" selected>5 jogos</option>
                    <option value="10">10 jogos</option>
                </select>
            </div>

            <div class="control-group">
                <label for="missingRange"><i class="fas fa-chart-line"></i> Dezenas faltantes por jogo:</label>
                <select id="missingRange">
                    <option value="3-5">3-5</option>
                    <option value="4-6" selected>4-6</option>
                    <option value="5-7">5-7</option>
                </select>
            </div>

            <div class="control-group">
                <label for="lastGames"><i class="fas fa-history"></i> Concursos analisados:</label>
                <select id="lastGames">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="fixedNumbers"><i class="fas fa-thumbtack"></i> Fixar dezenas:</label>
                <input type="text" id="fixedNumbers" placeholder="Ex: 3,7,15">
                <div id="fixedNumbersError" class="error-message" style="display: none;"></div>
            </div>

            <div class="control-group">
                <label for="excludedNumbers"><i class="fas fa-ban"></i> Excluir dezenas:</label>
                <input type="text" id="excludedNumbers" placeholder="Ex: 5,10,24">
                <div id="excludedNumbersError" class="error-message" style="display: none;"></div>
            </div>

            <div class="control-group">
                <label for="maxLastDraw"><i class="fas fa-sync"></i> Máx. dezenas do último sorteio:</label>
                <select id="maxLastDraw">
                    <option value="15">Sem limite</option>
                    <option value="10" selected>10</option>
                    <option value="8">8</option>
                    <option value="5">5</option>
                </select>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="balanceMode"><i class="fas fa-equals"></i> Balancear pares/ímpares:</label>
                <select id="balanceMode">
                    <option value="none">Não verificar</option>
                    <option value="normal" selected>Sim (entre 6 e 9)</option>
                    <option value="strict">Estrito (7 ou 8)</option>
                </select>
            </div>
        </div>

        <div class="game-card">
            <h3><i class="fas fa-mouse-pointer"></i> Seletor de Números</h3>
            <p>Clique nos números para fixá-los nos seus jogos:</p>
            <div class="number-grid" id="numberGrid"></div>
        </div>

        <div id="statusMessage"></div>

        <div class="missing-list" id="missingInfo">
            <p><i class="fas fa-info-circle"></i> Clique em "Gerar Jogos" para analisar dezenas faltantes.</p>
        </div>

        <div class="game-card">
            <div class="tabs">
                <div class="tab active" data-tab="stats">Estatísticas</div>
                <div class="tab" data-tab="frequency">Frequência</div>
                <div class="tab" data-tab="delays">Atrasos</div>
            </div>
            
            <div class="tab-content active" id="statsContent">
                <p><i class="fas fa-spinner fa-spin"></i> Carregando estatísticas...</p>
            </div>
            
            <div class="tab-content" id="frequencyContent">
                <div class="chart-container">
                    <canvas id="frequencyChart"></canvas>
                </div>
            </div>
            
            <div class="tab-content" id="delaysContent">
                <div class="chart-container">
                    <canvas id="delaysChart"></canvas>
                </div>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="game-card" style="text-align: center; background-color: var(--light);">
                <p><strong>Seus jogos gerados aparecerão aqui.</strong></p>
            </div>
        </div>
        
        <div class="game-card save-section">
            <h3><i class="fas fa-save"></i> Salvar Jogos</h3>
            <button class="btn" id="saveGamesBtn">
                <i class="fas fa-save"></i> Salvar Estes Jogos
            </button>
            
            <div class="saved-games" id="savedGamesList">
                <p>Nenhum jogo salvo ainda.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos do DOM
            const elements = {
                generateBtn: document.getElementById('generateBtn'),
                refreshBtn: document.getElementById('refreshBtn'),
                resultsContainer: document.getElementById('resultsContainer'),
                missingInfo: document.getElementById('missingInfo'),
                statsContent: document.getElementById('statsContent'),
                frequencyContent: document.getElementById('frequencyContent'),
                delaysContent: document.getElementById('delaysContent'),
                tabs: document.querySelectorAll('.tab'),
                saveGamesBtn: document.getElementById('saveGamesBtn'),
                savedGamesList: document.getElementById('savedGamesList'),
                numberGrid: document.getElementById('numberGrid'),
                fixedNumbersInput: document.getElementById('fixedNumbers'),
                excludedNumbersInput: document.getElementById('excludedNumbers'),
                fixedNumbersError: document.getElementById('fixedNumbersError'),
                excludedNumbersError: document.getElementById('excludedNumbersError'),
                statusMessage: document.getElementById('statusMessage'),
                gameQuantity: document.getElementById('gameQuantity'),
                missingRange: document.getElementById('missingRange'),
                lastGames: document.getElementById('lastGames'),
                maxLastDraw: document.getElementById('maxLastDraw'),
                balanceMode: document.getElementById('balanceMode')
            };

            // Gráficos
            let charts = {
                frequency: null,
                delays: null
            };
            
            // Dados
            let state = {
                resultados: [],
                isLoading: false,
                generatedGames: [],
                lastUpdateAttempt: 0,
                dataSource: null
            };
            
            // Constantes
            const constants = {
                CACHE_KEY: 'lotofacil_cache_v2',
                CACHE_EXPIRATION: 6 * 60 * 60 * 1000, // 6 horas
                MIN_GAMES: 5,
                MAX_SAVED_SETS: 10
            };

            // Inicialização
            initNumberGrid();
            loadData();
            loadSavedGames();
            setupEventListeners();
            
            function initNumberGrid() {
                elements.numberGrid.innerHTML = '';
                for (let i = 1; i <= 25; i++) {
                    const numElement = document.createElement('div');
                    numElement.className = 'grid-number';
                    numElement.textContent = i.toString().padStart(2, '0');
                    numElement.dataset.number = i;
                    numElement.addEventListener('click', toggleNumberSelection);
                    elements.numberGrid.appendChild(numElement);
                }
            }
            
            function toggleNumberSelection(e) {
                e.target.classList.toggle('selected');
                updateFixedNumbers();
            }
            
            function updateFixedNumbers() {
                const selected = Array.from(document.querySelectorAll('.grid-number.selected'))
                    .map(el => parseInt(el.dataset.number));
                elements.fixedNumbersInput.value = selected.join(',');
                validateNumberInputs();
            }
            
            function setupEventListeners() {
                // Botões
                elements.generateBtn.addEventListener('click', handleGenerateClick);
                elements.refreshBtn.addEventListener('click', handleRefreshClick);
                elements.saveGamesBtn.addEventListener('click', handleSaveClick);
                
                // Tabs
                elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
                });
                
                // Inputs
                elements.fixedNumbersInput.addEventListener('input', validateNumberInputs);
                elements.excludedNumbersInput.addEventListener('input', validateNumberInputs);
                
                // Atualizar seleção quando o input é alterado manualmente
                elements.fixedNumbersInput.addEventListener('change', function() {
                    updateNumberGridSelection(validateNumberInput(this.value));
                });
            }
            
            function handleGenerateClick() {
                if (state.isLoading) {
                    showStatus('Aguarde, os dados estão sendo carregados...', 'warning');
                    return;
                }
                
                if (state.resultados.length === 0) {
                    showStatus('Nenhum dado disponível. Atualize os dados primeiro.', 'error');
                    elements.refreshBtn.focus();
                    return;
                }
                
                generateGames();
            }
            
            function handleRefreshClick() {
                const now = Date.now();
                if (state.isLoading) {
                    showStatus('Já está atualizando, aguarde...', 'warning');
                    return;
                }
                
                if (now - state.lastUpdateAttempt < 10000) {
                    const secondsLeft = Math.ceil((10000 - (now - state.lastUpdateAttempt)) / 1000);
                    showStatus(`Aguarde ${secondsLeft} segundos antes de atualizar novamente`, 'warning');
                    return;
                }
                
                state.lastUpdateAttempt = now;
                loadData();
            }
            
            function handleSaveClick() {
                if (state.generatedGames.length === 0) {
                    showStatus('Nenhum jogo para salvar. Gere jogos primeiro.', 'error');
                    elements.generateBtn.focus();
                    return;
                }
                
                if (confirm('Deseja salvar estes jogos?')) {
                    saveGames();
                }
            }
            
            function switchTab(tabName) {
                // Atualizar tabs
                elements.tabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                
                // Atualizar conteúdo
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Content`).classList.add('active');
            }
            
            function validateNumberInputs() {
                // Valida números fixos
                const fixedNumbers = validateNumberInput(elements.fixedNumbersInput.value);
                if (fixedNumbers.length > 15) {
                    elements.fixedNumbersError.textContent = 'Máximo de 15 números fixos';
                    elements.fixedNumbersError.style.display = 'block';
                    elements.generateBtn.disabled = true;
                } else {
                    elements.fixedNumbersError.style.display = 'none';
                }
                
                // Valida números excluídos
                const excludedNumbers = validateNumberInput(elements.excludedNumbersInput.value);
                if (excludedNumbers.length > 20) {
                    elements.excludedNumbersError.textContent = 'Máximo de 20 números excluídos';
                    elements.excludedNumbersError.style.display = 'block';
                    elements.generateBtn.disabled = true;
                } else {
                    elements.excludedNumbersError.style.display = 'none';
                }
                
                // Atualiza estado do botão
                elements.generateBtn.disabled = state.isLoading || state.resultados.length === 0 || 
                    fixedNumbers.length > 15 || excludedNumbers.length > 20;
            }
            
            function validateNumberInput(input) {
                if (!input.trim()) return [];
                
                return input.split(',')
                    .map(n => parseInt(n.trim()))
                    .filter(n => !isNaN(n) && n >= 1 && n <= 25)
                    .filter((n, i, arr) => arr.indexOf(n) === i); // Remove duplicatas
            }
            
            function updateNumberGridSelection(numbers) {
                document.querySelectorAll('.grid-number').forEach(el => {
                    const num = parseInt(el.dataset.number);
                    el.classList.toggle('selected', numbers.includes(num));
                });
            }
            
            async function loadData() {
                if (state.isLoading) return;
                
                state.isLoading = true;
                updateButtonStates();
                showStatus('Conectando ao servidor de resultados...', 'info');
                
                try {
                    // Tentar primeiro o cache local
                    const cachedData = getCachedData();
                    if (cachedData && cachedData.length >= constants.MIN_GAMES) {
                        state.resultados = cachedData;
                        state.dataSource = 'cache';
                        showStatus('Dados carregados do cache (offline)', 'warning');
                        processResults();
                        return;
                    }
                    
                    // Tentar API principal (BrasilAPI)
                    const apiResponse = await tryBrasilAPI();
                    if (apiResponse) {
                        processData(apiResponse);
                        cacheData(state.resultados);
                        showStatus('Dados atualizados com sucesso!', 'success');
                    } else {
                        // Se a API falhar, usar dados de exemplo
                        useSampleData();
                        showStatus('Usando dados de exemplo. Atualize mais tarde.', 'warning');
                    }
                } catch (error) {
                    console.error("Erro ao carregar dados:", error);
                    const cachedData = getCachedData();
                    if (cachedData && cachedData.length >= constants.MIN_GAMES) {
                        state.resultados = cachedData;
                        state.dataSource = 'cache';
                        showStatus('Usando dados do cache devido a erro na conexão', 'warning');
                    } else {
                        useSampleData();
                        showStatus('Falha na conexão. Usando dados de exemplo.', 'error');
                    }
                } finally {
                    state.isLoading = false;
                    updateButtonStates();
                    processResults();
                }
            }

            // API principal - BrasilAPI (oficial e confiável)
            async function tryBrasilAPI() {
                try {
                    const response = await fetch('https://brasilapi.com.br/api/loteria/v1/lotofacil');
                    if (!response.ok) throw new Error('API não respondeu');
                    
                    const data = await response.json();
                    state.dataSource = 'brasilapi';
                    
                    // Formatar dados para o formato esperado
                    const formattedData = data.concursos.map(concurso => ({
                        concurso: concurso.numero,
                        data: concurso.data,
                        numeros: concurso.dezenas.map(Number).sort((a, b) => a - b)
                    })).sort((a, b) => b.concurso - a.concurso); // Ordenar do mais recente
                    
                    return formattedData;
                } catch (error) {
                    console.log("BrasilAPI falhou:", error);
                    return null;
                }
            }

            // Sistema de cache local
            function getCachedData() {
                const cached = localStorage.getItem(constants.CACHE_KEY);
                if (!cached) return null;
                
                try {
                    const { data, timestamp } = JSON.parse(cached);
                    
                    // Verificar se o cache está expirado
                    if (Date.now() - timestamp > constants.CACHE_EXPIRATION) {
                        return null;
                    }
                    
                    return data;
                } catch (e) {
                    return null;
                }
            }

            function cacheData(data) {
                try {
                    const cache = {
                        data: data,
                        timestamp: Date.now(),
                        source: state.dataSource
                    };
                    localStorage.setItem(constants.CACHE_KEY, JSON.stringify(cache));
                } catch (e) {
                    console.error("Erro ao salvar cache:", e);
                }
            }

            function processData(data) {
                try {
                    if (!Array.isArray(data)) {
                        throw new Error("Dados não são um array");
                    }
                    
                    // Ordenar por concurso (mais recente primeiro)
                    state.resultados = data.sort((a, b) => b.concurso - a.concurso);
                    
                    // Garantir que temos pelo menos o mínimo de resultados
                    if (state.resultados.length < constants.MIN_GAMES) {
                        const missing = constants.MIN_GAMES - state.resultados.length;
                        for (let i = 0; i < missing; i++) {
                            state.resultados.push(generateSampleResult(state.resultados[0].concurso - (i + 1)));
                        }
                    }
                } catch (e) {
                    console.error("Erro ao processar dados:", e);
                    useSampleData();
                }
            }

            function generateSampleResult(concurso) {
                // Gerar um resultado aleatório para preencher quando não há dados suficientes
                const randomNumbers = [];
                while (randomNumbers.length < 15) {
                    const num = Math.floor(Math.random() * 25) + 1;
                    if (!randomNumbers.includes(num)) {
                        randomNumbers.push(num);
                    }
                }
                
                return {
                    concurso: concurso,
                    data: new Date(Date.now() - (Math.random() * 30 * 24 * 60 * 60 * 1000)).toLocaleDateString(),
                    numeros: randomNumbers.sort((a, b) => a - b)
                };
            }

            function useSampleData() {
                state.resultados = [
                    { concurso: 2900, data: "01/04/2025", numeros: [1, 2, 3, 5, 8, 9, 12, 14, 16, 18, 20, 21, 23, 24, 25] },
                    { concurso: 2899, data: "30/03/2025", numeros: [3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 22, 23, 24, 25, 10] },
                    { concurso: 2898, data: "27/03/2025", numeros: [2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 1, 3, 5] },
                    { concurso: 2897, data: "25/03/2025", numeros: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 2, 4] },
                    { concurso: 2896, data: "23/03/2025", numeros: [5, 10, 15, 20, 25, 4, 9, 14, 19, 24, 3, 8, 13, 18, 23] }
                ];
                
                state.dataSource = 'exemplo';
            }
            
            function processResults() {
                calcularEstatisticas();
                updateCharts();
                validateNumberInputs();
                
                // Mostrar a fonte dos dados
                showStatus(getDataSourceMessage(), 'info');
            }

            function getDataSourceMessage() {
                switch(state.dataSource) {
                    case 'brasilapi': return 'Dados obtidos da BrasilAPI (oficial)';
                    case 'cache': return 'Dados carregados do cache local';
                    case 'exemplo': return 'Dados de exemplo utilizados';
                    default: return 'Fonte de dados desconhecida';
                }
            }

            function updateButtonStates() {
                elements.generateBtn.disabled = state.isLoading || state.resultados.length === 0;
                elements.refreshBtn.disabled = state.isLoading;
                
                if (state.isLoading) {
                    elements.generateBtn.innerHTML = '<span class="loading"></span> Aguarde...';
                    elements.refreshBtn.innerHTML = '<span class="loading"></span> Atualizando...';
                } else {
                    elements.generateBtn.innerHTML = '<i class="fas fa-dice"></i> Gerar Jogos';
                    elements.refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar Dados';
                }
            }
            
            function generateGames() {
                if (state.isLoading) return;
                
                const quantity = parseInt(elements.gameQuantity.value);
                const [minMissing, maxMissing] = elements.missingRange.value.split('-').map(Number);
                const lastGames = parseInt(elements.lastGames.value);
                const fixedNumbers = validateNumberInput(elements.fixedNumbersInput.value.trim());
                const excludedNumbers = validateNumberInput(elements.excludedNumbersInput.value.trim());
                const maxLastDrawAllowed = parseInt(elements.maxLastDraw.value);
                const balanceMode = elements.balanceMode.value;
                
                if (fixedNumbers.length > 15) {
                    showStatus('Você pode fixar no máximo 15 números.', 'error');
                    return;
                }
                
                if (excludedNumbers.length > 20) {
                    showStatus('Você pode excluir no máximo 20 números.', 'error');
                    return;
                }
                
                if (state.resultados.length === 0) {
                    showStatus('Nenhum dado disponível. Tente atualizar.', 'error');
                    return;
                }
                
                elements.generateBtn.innerHTML = '<span class="loading"></span> Gerando...';
                elements.generateBtn.disabled = true;
                
                // Processamento assíncrono para não travar a UI
                setTimeout(() => {
                    try {
                        const missingNumbers = getMissingNumbers(lastGames).filter(n => !excludedNumbers.includes(n));
                        state.generatedGames = [];
                        
                        for (let i = 0; i < quantity; i++) {
                            let tentativa = 0;
                            let game;
                            
                            do {
                                game = generateGame(missingNumbers, minMissing, maxMissing, fixedNumbers);
                                tentativa++;
                                
                                // Verificar limite de dezenas do último sorteio
                                const lastResult = state.resultados[0]?.numeros || [];
                                const countLast = game.numbers.filter(n => lastResult.includes(n)).length;
                                
                                // Verificar balanceamento pares/ímpares
                                const isBalanced = checkBalance(game.numbers, balanceMode);
                                
                                if (countLast <= maxLastDrawAllowed && isBalanced) break;
                            } while (tentativa < 100);
                            
                            state.generatedGames.push(game);
                        }
                        
                        displayResults(state.generatedGames, missingNumbers);
                        showStatus(`${quantity} jogos gerados com sucesso!`, 'success');
                    } catch (error) {
                        console.error("Erro ao gerar jogos:", error);
                        showStatus('Erro ao gerar jogos. Tente novamente.', 'error');
                    } finally {
                        elements.generateBtn.innerHTML = '<i class="fas fa-dice"></i> Gerar Jogos';
                        elements.generateBtn.disabled = false;
                    }
                }, 100);
            }
            
            function getMissingNumbers(lastGames) {
                const recentResults = state.resultados.slice(0, lastGames);
                const drawnNumbers = new Set();
                
                recentResults.forEach(result => {
                    result.numeros.forEach(num => drawnNumbers.add(num));
                });
                
                return Array.from({length: 25}, (_, i) => i + 1)
                    .filter(num => !drawnNumbers.has(num));
            }
            
            function generateGame(missingNumbers, minMissing, maxMissing, fixedNumbers) {
                // Quantidade de dezenas faltantes neste jogo (entre min e max)
                const missingCount = Math.floor(Math.random() * (maxMissing - minMissing + 1)) + minMissing;
                const selectedMissing = shuffleArray([...missingNumbers]).slice(0, missingCount);
                
                // Dezenas que apareceram recentemente (exceto fixas e excluídas)
                const regularNumbers = Array.from({length: 25}, (_, i) => i + 1)
                    .filter(n => !missingNumbers.includes(n) && !fixedNumbers.includes(n));
                
                // Completa com dezenas recentes
                const regularCount = 15 - selectedMissing.length - fixedNumbers.length;
                const selectedRegular = shuffleArray(regularNumbers).slice(0, regularCount);
                
                return {
                    numbers: [...fixedNumbers, ...selectedMissing, ...selectedRegular].sort((a, b) => a - b),
                    missing: selectedMissing,
                    date: new Date().toLocaleString()
                };
            }
            
            function checkBalance(numbers, mode) {
                const pares = numbers.filter(n => n % 2 === 0).length;
                
                if (mode === 'none') return true;
                if (mode === 'normal') return pares >= 6 && pares <= 9;
                if (mode === 'strict') return pares === 7 || pares === 8;
                
                return true;
            }
            
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            function displayResults(games, allMissing) {
                // Atualizar informação de dezenas faltantes
                elements.missingInfo.innerHTML = `
                    <h3><i class="fas fa-info-circle"></i> Dezenas Faltantes (últimos ${elements.lastGames.value} concursos)</h3>
                    <div class="game-numbers">
                        ${allMissing.length > 0 ? 
                            allMissing.map(num => `<span class="numero missing">${num.toString().padStart(2, '0')}</span>`).join('') : 
                            '<p>Todas as dezenas apareceram nos últimos concursos</p>'}
                    </div>
                    <p>Total: ${allMissing.length} dezenas não sorteadas recentemente</p>
                `;
                
                // Exibir jogos gerados
                let html = '';
                
                games.forEach((game, index) => {
                    const pares = game.numbers.filter(n => n % 2 === 0).length;
                    const impares = 15 - pares;
                    const sum = game.numbers.reduce((a, b) => a + b, 0);
                    
                    html += `
                        <div class="game-card">
                            <div class="game-header">
                                <h3>Jogo ${index + 1}</h3>
                                <div style="display: flex; gap: 8px;">
                                    <span class="badge">${game.missing.length} faltantes</span>
                                    <span class="badge" style="background: var(--primary)">${pares}P ${impares}I</span>
                                </div>
                            </div>
                            <div class="game-numbers">
                                ${game.numbers.map(num => `
                                    <span class="numero ${game.missing.includes(num) ? 'missing' : ''}" 
                                        title="${game.missing.includes(num) ? 'Dezena faltante' : 'Dezena recente'}">
                                        ${num.toString().padStart(2, '0')}
                                    </span>
                                `).join('')}
                            </div>
                            <p><small>Soma: ${sum} | ${game.numbers.join(', ')}</small></p>
                        </div>
                    `;
                });
                
                elements.resultsContainer.innerHTML = html;
            }
            
            function calcularEstatisticas() {
                if (state.resultados.length === 0) {
                    elements.statsContent.innerHTML = '<p>Nenhum dado disponível.</p>';
                    return;
                }
                
                const todas = state.resultados.flatMap(r => r.numeros);
                const contagem = {};
                
                for (let i = 1; i <= 25; i++) contagem[i] = 0;
                todas.forEach(n => contagem[n]++);
                
                const lista = Object.entries(contagem).sort((a, b) => b[1] - a[1]);
                
                const maisFrequentes = lista.slice(0, 5).map(([n, c]) => `${n} (${c}x)`);
                const menosFrequentes = lista.slice(-5).map(([n, c]) => `${n} (${c}x)`);
                
                const ausencias = {};
                for (let i = 1; i <= 25; i++) ausencias[i] = 0;
                
                state.resultados.forEach((r, idx) => {
                    for (let i = 1; i <= 25; i++) {
                        if (!r.numeros.includes(i)) {
                            ausencias[i]++;
                        } else {
                            ausencias[i] = 0;
                        }
                    }
                });
                
                const maisAtrasadas = Object.entries(ausencias)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([n, a]) => `${n} (${a} concursos)`);
                
                elements.statsContent.innerHTML = `
                    <p><strong>Último sorteio:</strong> Concurso ${state.resultados[0].concurso} (${state.resultados[0].data})</p>
                    <p><strong>Dezenas sorteadas:</strong> ${state.resultados[0].numeros.join(', ')}</p>
                    <p><strong>Dezenas quentes (mais sorteadas):</strong> ${maisFrequentes.join(', ')}</p>
                    <p><strong>Dezenas frias (menos sorteadas):</strong> ${menosFrequentes.join(', ')}</p>
                    <p><strong>Dezenas mais atrasadas:</strong> ${maisAtrasadas.join(', ')}</p>
                    <p><small>Fonte: ${getDataSourceName()}</small></p>
                `;
            }
            
            function getDataSourceName() {
                switch(state.dataSource) {
                    case 'brasilapi': return 'BrasilAPI';
                    case 'cache': return 'Cache Local';
                    case 'exemplo': return 'Dados de Exemplo';
                    default: return 'Desconhecida';
                }
            }
            
            function updateCharts() {
                if (state.resultados.length === 0) return;
                
                // Dados para gráficos
                const todas = state.resultados.flatMap(r => r.numeros);
                const contagem = {};
                for (let i = 1; i <= 25; i++) contagem[i] = 0;
                todas.forEach(n => contagem[n]++);
                
                const ausencias = {};
                for (let i = 1; i <= 25; i++) ausencias[i] = 0;
                
                state.resultados.forEach((r, idx) => {
                    for (let i = 1; i <= 25; i++) {
                        if (!r.numeros.includes(i)) {
                            ausencias[i]++;
                        } else {
                            ausencias[i] = 0;
                        }
                    }
                });
                
                // Configuração dos gráficos
                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Frequência: ${context.raw}`;
                                }
                            }
                        }
                    }
                };
                
                // Gráfico de frequência
                if (charts.frequency) charts.frequency.destroy();
                const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
                charts.frequency = new Chart(frequencyCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(contagem),
                        datasets: [{
                            label: 'Frequência de sorteio',
                            data: Object.values(contagem),
                            backgroundColor: Array.from({length: 25}, (_, i) => 
                                i < 5 ? 'rgba(231, 76, 60, 0.7)' : 
                                i >= 20 ? 'rgba(46, 204, 113, 0.7)' : 
                                'rgba(52, 152, 219, 0.7)'),
                            borderColor: Array.from({length: 25}, (_, i) => 
                                i < 5 ? 'rgba(231, 76, 60, 1)' : 
                                i >= 20 ? 'rgba(46, 204, 113, 1)' : 
                                'rgba(52, 152, 219, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: chartOptions
                });
                
                // Gráfico de atrasos
                if (charts.delays) charts.delays.destroy();
                const delaysCtx = document.getElementById('delaysChart').getContext('2d');
                charts.delays = new Chart(delaysCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(ausencias),
                        datasets: [{
                            label: 'Concursos sem ser sorteada',
                            data: Object.values(ausencias),
                            backgroundColor: Array.from({length: 25}, (_, i) => 
                                Object.values(ausencias)[i] > 10 ? 'rgba(231, 76, 60, 0.7)' : 
                                'rgba(52, 152, 219, 0.7)'),
                            borderColor: Array.from({length: 25}, (_, i) => 
                                Object.values(ausencias)[i] > 10 ? 'rgba(231, 76, 60, 1)' : 
                                'rgba(52, 152, 219, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Atraso: ${context.raw} concursos`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function saveGames() {
                try {
                    let savedGames = JSON.parse(localStorage.getItem('lotofacilSavedGames') || '[]');
                    
                    // Limitar a quantidade máxima de conjuntos salvos
                    if (savedGames.length >= constants.MAX_SAVED_SETS) {
                        if (!confirm(`Você já tem ${constants.MAX_SAVED_SETS} conjuntos salvos. Deseja substituir o mais antigo?`)) {
                            return;
                        }
                        savedGames = savedGames.slice(0, constants.MAX_SAVED_SETS - 1);
                    }
                    
                    const gamesToSave = {
                        date: new Date().toLocaleString(),
                        games: state.generatedGames,
                        config: getCurrentConfig(),
                        dataSource: state.dataSource
                    };
                    
                    savedGames.unshift(gamesToSave);
                    localStorage.setItem('lotofacilSavedGames', JSON.stringify(savedGames));
                    
                    showStatus(`Jogos salvos com sucesso! Total: ${savedGames.length} conjuntos`, 'success');
                    loadSavedGames();
                } catch (error) {
                    console.error("Erro ao salvar jogos:", error);
                    showStatus('Erro ao salvar jogos. O localStorage pode estar cheio.', 'error');
                }
            }
            
            function getCurrentConfig() {
                return {
                    quantity: elements.gameQuantity.value,
                    missingRange: elements.missingRange.value,
                    lastGames: elements.lastGames.value,
                    fixedNumbers: validateNumberInput(elements.fixedNumbersInput.value.trim()),
                    excludedNumbers: validateNumberInput(elements.excludedNumbersInput.value.trim()),
                    maxLastDraw: elements.maxLastDraw.value,
                    balanceMode: elements.balanceMode.value
                };
            }
            
            function loadSavedGames() {
                try {
                    let savedGames = JSON.parse(localStorage.getItem('lotofacilSavedGames') || '[]');
                    if (typeof savedGames === 'string') {
                        savedGames = JSON.parse(savedGames);
                    }
                    
                    if (!Array.isArray(savedGames)) {
                        savedGames = [];
                    }
                    
                    if (savedGames.length === 0) {
                        elements.savedGamesList.innerHTML = '<p>Nenhum jogo salvo ainda.</p>';
                        return;
                    }
                    
                    let html = '';
                    savedGames.forEach((group, groupIndex) => {
                        html += `
                            <div class="saved-game">
                                <div>
                                    <strong>Jogos de ${group.date}</strong>
                                    <div class="saved-game-date">
                                        ${group.games.length} jogos | 
                                        Últimos ${group.config.lastGames} concursos | 
                                        ${group.config.missingRange} faltantes
                                        <br>Fonte: ${group.dataSource || 'desconhecida'}
                                    </div>
                                </div>
                                <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="loadSavedGame(${groupIndex})">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </div>
                        `;
                    });
                    
                    elements.savedGamesList.innerHTML = html;
                } catch (error) {
                    console.error("Erro ao carregar jogos salvos:", error);
                    elements.savedGamesList.innerHTML = '<p class="error-message">Erro ao carregar jogos salvos</p>';
                }
            }
            
            function showStatus(message, type = 'info') {
                const icons = {
                    error: 'times-circle',
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                messageDiv.innerHTML = `
                    <i class="fas fa-${icons[type]}"></i>
                    <span>${message}</span>
                `;
                
                // Limpar mensagens anteriores
                while (elements.statusMessage.firstChild) {
                    elements.statusMessage.removeChild(elements.statusMessage.firstChild);
                }
                
                elements.statusMessage.appendChild(messageDiv);
                
                // Remove mensagem após 5 segundos (exceto erros)
                if (type !== 'error') {
                    setTimeout(() => {
                        if (elements.statusMessage.contains(messageDiv)) {
                            elements.statusMessage.removeChild(messageDiv);
                        }
                    }, 5000);
                }
            }
            
            // Função global para carregar jogos salvos
            window.loadSavedGame = function(index) {
                try {
                    let savedGames = JSON.parse(localStorage.getItem('lotofacilSavedGames') || []);
                    
                    if (index >= savedGames.length) {
                        showStatus('Conjunto de jogos não encontrado', 'error');
                        return;
                    }
                    
                    const savedGame = savedGames[index];
                    
                    // Aplicar configurações salvas
                    elements.gameQuantity.value = savedGame.config.quantity;
                    elements.missingRange.value = savedGame.config.missingRange;
                    elements.lastGames.value = savedGame.config.lastGames;
                    elements.fixedNumbersInput.value = savedGame.config.fixedNumbers.join(',');
                    elements.excludedNumbersInput.value = savedGame.config.excludedNumbers.join(',');
                    elements.maxLastDraw.value = savedGame.config.maxLastDraw;
                    elements.balanceMode.value = savedGame.config.balanceMode;
                    
                    // Atualizar UI
                    updateNumberGridSelection(savedGame.config.fixedNumbers);
                    validateNumberInputs();
                    
                    // Exibir jogos
                    const missingNumbers = getMissingNumbers(savedGame.config.lastGames)
                        .filter(n => !savedGame.config.excludedNumbers.includes(n));
                    
                    state.generatedGames = savedGame.games;
                    state.dataSource = savedGame.dataSource || 'desconhecida';
                    displayResults(savedGame.games, missingNumbers);
                    showStatus(`Jogos carregados (salvos em ${savedGame.date})`, 'success');
                } catch (error) {
                    console.error("Erro ao carregar jogo salvo:", error);
                    showStatus('Erro ao carregar jogo salvo', 'error');
                }
            };
        });
    </script>
</body>
</html>
