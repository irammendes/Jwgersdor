<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotofácil Pro - Gerador Estratégico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            margin: 0;
            padding: 20px;
            color: var(--primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--secondary);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
        }

        .game-card {
            background: var(--white);
            border-left: 5px solid var(--success);
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .numero {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary);
            color: var(--white);
            border-radius: 50%;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .excluded {
            opacity: 0.4;
            transform: scale(0.8);
            background: var(--danger);
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .statistics-panel {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
        }

        .cycle-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .cycle-table th,
        .cycle-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .cycle-table th {
            background: var(--primary);
            color: var(--white);
        }

        .btn {
            padding: 12px 25px;
            background: var(--secondary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Gerador Estratégico Lotofácil 5.0</h1>
            <div>
                <button class="btn" id="generateBtn">
                    <i class="fas fa-dice"></i> Gerar Jogos
                </button>
                <button class="btn" id="exportBtn" style="display: none; background: var(--success);">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
            </div>
        </div>

        <div class="controls-grid">
            <div class="control-group">
                <label><i class="fas fa-sliders-h"></i> Configurações Principais</label>
                <div class="controls">
                    <input type="number" id="gameQuantity" min="1" max="20" value="5" class="form-control">
                    <select id="missingRange" class="form-control">
                        <option value="3-5">3-5 Faltantes</option>
                        <option value="4-6">4-6 Faltantes</option>
                        <option value="5-7">5-7 Faltantes</option>
                    </select>
                    <select id="lastGames" class="form-control">
                        <option value="5">Últimos 5 concursos</option>
                        <option value="10" selected>Últimos 10 concursos</option>
                        <option value="15">Últimos 15 concursos</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <label><i class="fas fa-filter"></i> Filtros Avançados</label>
                <div class="controls">
                    <input type="text" id="fixedNumbers" placeholder="Fixar dezenas (ex: 3,7,15)">
                    <input type="text" id="excludedNumbers" placeholder="Excluir dezenas (ex: 5,10,24)">
                    <select id="maxLastDraw" class="form-control">
                        <option value="15">Máx. 15 repetidas do último</option>
                        <option value="10">Máx. 10 repetidas do último</option>
                        <option value="5">Máx. 5 repetidas do último</option>
                    </select>
                    <select id="balanceMode" class="form-control">
                        <option value="flex">Balanceamento Flexível</option>
                        <option value="strict" selected>Balanceamento Rigoroso</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-container">
                <canvas id="frequencyChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="probabilityChart"></canvas>
            </div>
        </div>

        <div class="statistics-panel">
            <h3><i class="fas fa-history"></i> Estatísticas de Ciclos</h3>
            <div id="cycleCounter"></div>
            <table class="cycle-table">
                <thead>
                    <tr>
                        <th>Dezena</th>
                        <th>Ausência Atual</th>
                        <th>Recorde</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="absenceTable"></tbody>
            </table>
        </div>

        <div id="resultsContainer"></div>
    </div>

    <script>
        const state = {
            resultados: [],
            generatedGames: [],
            cycles: {
                current: 1,
                absenceStreaks: {},
                maxAbsence: {},
                numbersInCycle: new Set()
            },
            charts: {
                frequency: null,
                probability: null
            }
        };

        // Core Functions
        async function loadData() {
            try {
                state.cycles = resetCycles(); // Reiniciar ciclos ao carregar novos dados
                const response = await fetch('https://servicebus2.caixa.gov.br/portaldeloterias/api/lotofacil');
                const data = await response.json() || [];
                
                state.resultados = Array.isArray(data) ? data : [data];
                state.resultados.forEach(sorteio => {
                    processResults(sorteio.listaDezenas.map(Number));
                });
                showSuccess('Dados atualizados via API!');
            } catch (error) {
                useSampleData();
                showWarning('Usando dados de exemplo');
            }
            updateProbabilityChart();
        }

        function generateGames() {
            const params = getGenerationParams();
            validateInputs(params);
            
            state.generatedGames = [];
            for(let i = 0; i < params.quantity; i++) {
                const game = createValidGame(params);
                state.generatedGames.push(game);
                processResults(game.numbers);
            }
            
            updateInterface();
            updateCharts();
            state.exportBtn.style.display = 'block';
        }

        // Statistics and Cycles Management
        function processResults(numbers) {
            numbers = numbers.map(Number);
            
            // Update cycles
            numbers.forEach(n => {
                state.cycles.numbersInCycle.add(n);
                state.cycles.absenceStreaks[n] = 0;
            });

            // Check for new cycle
            if(state.cycles.numbersInCycle.size >= 25) {
                state.cycles.current++;
                state.cycles.numbersInCycle.clear();
                Array.from({length: 25}, (_, i) => i+1).forEach(n => {
                    state.cycles.absenceStreaks[n] = 0;
                });
            }

            // Update absence streaks
            Array.from({length: 25}, (_, i) => i+1).forEach(n => {
                if(!numbers.includes(n)) {
                    state.cycles.absenceStreaks[n] = (state.cycles.absenceStreaks[n] || 0) + 1;
                    state.cycles.maxAbsence[n] = Math.max(
                        state.cycles.maxAbsence[n] || 0, 
                        state.cycles.absenceStreaks[n]
                    );
                }
            });

            updateCycleTable();
        }

        // Visualization
        function updateCycleTable() {
            let tableHTML = '';
            for(let num = 1; num <= 25; num++) {
                tableHTML += `
                    <tr>
                        <td>${num.toString().padStart(2, '0')}</td>
                        <td>${state.cycles.absenceStreaks[num] || 0}</td>
                        <td>${state.cycles.maxAbsence[num] || '-'}</td>
                        <td>${state.cycles.numbersInCycle.has(num) ? '✅' : '❌'}</td>
                    </tr>
                `;
            }
            document.getElementById('absenceTable').innerHTML = tableHTML;
            document.getElementById('cycleCounter').textContent = 
                `Ciclo Atual: ${state.cycles.current} | ` +
                `Números no ciclo: ${state.cycles.numbersInCycle.size}/25`;
        }

        function updateCharts() {
            updateFrequencyChart();
            updateProbabilityChart();
        }

        function updateFrequencyChart() {
            if(state.charts.frequency) state.charts.frequency.destroy();
            
            const ctx = document.getElementById('frequencyChart').getContext('2d');
            state.charts.frequency = new Chart(ctx, {
                type: 'bar',
                data: getChartData(),
                options: getChartOptions('Frequência nos Jogos Gerados')
            });
        }

        function updateProbabilityChart() {
            if(state.charts.probability) state.charts.probability.destroy();
            
            const ctx = document.getElementById('probabilityChart').getContext('2d');
            state.charts.probability = new Chart(ctx, {
                type: 'line',
                data: getProbabilityData(),
                options: getChartOptions('Probabilidade Histórica (%)', true)
            });
        }

        // Utility Functions
        function resetCycles() {
            return {
                current: 1,
                absenceStreaks: {},
                maxAbsence: {},
                numbersInCycle: new Set()
            };
        }

        function getGenerationParams() {
            return {
                quantity: parseInt(document.getElementById('gameQuantity').value),
                missingRange: document.getElementById('missingRange').value.split('-').map(Number),
                lastGames: parseInt(document.getElementById('lastGames').value),
                fixedNumbers: parseNumberList('fixedNumbers'),
                excludedNumbers: parseNumberList('excludedNumbers'),
                maxLastDraw: parseInt(document.getElementById('maxLastDraw').value),
                balanceMode: document.getElementById('balanceMode').value
            };
        }

        function parseNumberList(inputId) {
            return document.getElementById(inputId).value
                .split(',')
                .map(n => parseInt(n.trim()))
                .filter(n => !isNaN(n) && n >= 1 && n <= 25);
        }

        function useSampleData() {
            state.resultados = [
                {"numeros":[1,2,3,5,8,9,12,14,16,18,20,21,23,24,25]},
                {"numeros":[3,5,7,9,11,13,15,17,19,21,22,23,24,25,10]},
                {"numeros":[2,4,6,8,10,12,14,16,18,20,22,24,1,3,5]}
            ].map(sorteio => ({ listaDezenas: sorteio.numeros }));
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            state.exportBtn = document.getElementById('exportBtn');
            document.getElementById('generateBtn').addEventListener('click', generateGames);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            loadData();
        });

        function exportToCSV() {
            const csvContent = state.generatedGames
                .map((game, i) => `Jogo ${i+1};${game.numbers.map(n => n.toString().padStart(2, '0')).join(';')}`)
                .join('\n');
            
            const blob = new Blob(["\ufeff" + csvContent], {type: 'text/csv;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lotofacil_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // [Restante das funções auxiliares...]
    </script>
</body>
</html>
