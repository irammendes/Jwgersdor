<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotofácil Genius - Gerador Inteligente</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        h1, h2, h3 {
            margin: 0;
            padding: 0;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        h2 {
            color: var(--primary-color);
            margin: 25px 0 15px;
            font-size: 1.8rem;
        }

        h3 {
            color: var(--secondary-color);
            margin: 20px 0 10px;
            font-size: 1.4rem;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        select, input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .ciclo {
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .ciclo:hover {
            transform: translateX(5px);
        }

        .numero-sorteado {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            margin: 5px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .jogo-gerado {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border: 1px dashed var(--secondary-color);
        }

        .historico-jogos {
            margin-top: 30px;
        }

        .jogo-salvo {
            background-color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .jogo-salvo .numeros {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--secondary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--danger-color);
            background-color: #fadbd8;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        .success-message {
            color: var(--success-color);
            background-color: #d5f5e3;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1><i class="fas fa-magic"></i> Lotofácil Genius</h1>
            <p>Gerador inteligente de jogos baseado em análise estatística</p>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <h2><i class="fas fa-filter"></i> Filtros Avançados</h2>
            <div class="filter-section">
                <div class="filter-group">
                    <label for="filter-cycle"><i class="fas fa-history"></i> Ciclo</label>
                    <select id="filter-cycle">
                        <option value="all">Todos os ciclos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-date"><i class="far fa-calendar-alt"></i> Período</label>
                    <input type="date" id="filter-date">
                </div>
                <div class="filter-group">
                    <label for="filter-absent"><i class="fas fa-ban"></i> Dezenas ausentes mínimas</label>
                    <select id="filter-absent">
                        <option value="0">Qualquer quantidade</option>
                        <option value="10">10+ dezenas</option>
                        <option value="15">15+ dezenas</option>
                        <option value="20">20+ dezenas</option>
                    </select>
                </div>
                <button id="apply-filters" class="btn-primary"><i class="fas fa-check"></i> Aplicar Filtros</button>
                <button id="reset-filters" class="btn-danger"><i class="fas fa-undo"></i> Limpar</button>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-chart-line"></i> Estatísticas</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total de Ciclos</div>
                    <div class="stat-value" id="total-cycles">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Dezenas Ausentes Média</div>
                    <div class="stat-value" id="avg-absent">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Maior Ciclo</div>
                    <div class="stat-value" id="max-cycle">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Jogos Gerados</div>
                    <div class="stat-value" id="total-games">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-list-ol"></i> Ciclos da Lotofácil</h2>
            <div id="loading-cycles" class="loading">
                <div class="spinner"></div>
                <span>Carregando ciclos...</span>
            </div>
            <div id="error-cycles" class="error-message" style="display: none;"></div>
            <div id="ciclos"></div>
        </div>

        <div class="card">
            <h2><i class="fas fa-ticket-alt"></i> Jogo Gerado</h2>
            <div id="resultado" class="jogo-gerado">
                <p class="no-data">Nenhum jogo gerado ainda. Selecione um ciclo para gerar um jogo inteligente.</p>
            </div>
            <div class="actions">
                <button id="save-game" class="btn-success" disabled><i class="far fa-save"></i> Salvar Jogo</button>
                <button id="new-random" class="btn-primary"><i class="fas fa-random"></i> Aleatório Completo</button>
                <button id="clear-game" class="btn-danger" disabled><i class="far fa-trash-alt"></i> Limpar</button>
            </div>
        </div>

        <div class="card historico-jogos">
            <h2><i class="fas fa-history"></i> Histórico de Jogos</h2>
            <div id="saved-games">
                <p class="no-data">Nenhum jogo salvo ainda. Gere e salve jogos para vê-los aqui.</p>
            </div>
            <div class="actions">
                <button id="clear-history" class="btn-danger"><i class="fas fa-trash"></i> Limpar Histórico</button>
                <button id="export-games" class="btn-primary"><i class="fas fa-file-export"></i> Exportar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos DOM
            const elementos = {
                ciclosContainer: document.getElementById('ciclos'),
                loadingCycles: document.getElementById('loading-cycles'),
                errorCycles: document.getElementById('error-cycles'),
                resultado: document.getElementById('resultado'),
                savedGames: document.getElementById('saved-games'),
                filterCycle: document.getElementById('filter-cycle'),
                filterDate: document.getElementById('filter-date'),
                filterAbsent: document.getElementById('filter-absent'),
                applyFilters: document.getElementById('apply-filters'),
                resetFilters: document.getElementById('reset-filters'),
                saveGame: document.getElementById('save-game'),
                newRandom: document.getElementById('new-random'),
                clearGame: document.getElementById('clear-game'),
                clearHistory: document.getElementById('clear-history'),
                exportGames: document.getElementById('export-games'),
                totalCycles: document.getElementById('total-cycles'),
                avgAbsent: document.getElementById('avg-absent'),
                maxCycle: document.getElementById('max-cycle'),
                totalGames: document.getElementById('total-games')
            };

            // Estado da aplicação
            const state = {
                ciclos: [],
                filteredCiclos: [],
                currentGame: null,
                savedGames: JSON.parse(localStorage.getItem('lotofacilSavedGames')) || [],
                filters: {
                    cycle: 'all',
                    date: null,
                    minAbsent: 0
                }
            };

            // Constantes
            const API_URL = "https://loteriascaixa-api.herokuapp.com/api/lotofacil/ciclos";
            const BACKUP_API_URL = "https://backup.loteriascaixa-api.herokuapp.com/api/lotofacil/ciclos";
            const ALL_NUMBERS = Array.from({length: 25}, (_, i) => i + 1);

            // Inicialização
            init();

            // Funções principais
            async function init() {
                setupEventListeners();
                await loadCycles();
                updateStats();
                renderSavedGames();
                setupDateFilter();
            }

            function setupEventListeners() {
                elementos.applyFilters.addEventListener('click', applyFilters);
                elementos.resetFilters.addEventListener('click', resetFilters);
                elementos.saveGame.addEventListener('click', saveCurrentGame);
                elementos.newRandom.addEventListener('click', generateFullRandomGame);
                elementos.clearGame.addEventListener('click', clearCurrentGame);
                elementos.clearHistory.addEventListener('click', clearHistory);
                elementos.exportGames.addEventListener('click', exportGames);
            }

            async function loadCycles() {
                showLoading();
                try {
                    const data = await fetchWithFallback(API_URL, BACKUP_API_URL);
                    if (data && Array.isArray(data)) {
                        state.ciclos = data.map(ciclo => ({
                            ...ciclo,
                            date: parseCycleDate(ciclo.ciclo)
                        })).sort((a, b) => b.ciclo - a.ciclo);
                        
                        state.filteredCiclos = [...state.ciclos];
                        renderCycleFilters();
                        renderCycles();
                        updateStats();
                    } else {
                        throw new Error('Dados recebidos são inválidos');
                    }
                } catch (error) {
                    showError(`Falha ao carregar ciclos: ${error.message}`);
                    console.error("Erro ao carregar ciclos:", error);
                } finally {
                    hideLoading();
                }
            }

            async function fetchWithFallback(primaryUrl, fallbackUrl) {
                try {
                    const response = await fetch(primaryUrl);
                    if (!response.ok) throw new Error('Primary API failed');
                    return await response.json();
                } catch (primaryError) {
                    console.warn("Usando API de backup:", primaryError);
                    try {
                        const backupResponse = await fetch(fallbackUrl);
                        if (!backupResponse.ok) throw new Error('Backup API failed');
                        return await backupResponse.json();
                    } catch (backupError) {
                        throw new Error(`Ambas as APIs falharam: ${primaryError.message}, ${backupError.message}`);
                    }
                }
            }

            function parseCycleDate(cycleNumber) {
                // Implementação fictícia - na prática você precisaria de uma lógica para converter ciclo em data
                const baseDate = new Date();
                baseDate.setDate(baseDate.getDate() - (cycleNumber * 3));
                return baseDate;
            }

            function renderCycleFilters() {
                elementos.filterCycle.innerHTML = '<option value="all">Todos os ciclos</option>';
                
                state.ciclos.forEach(ciclo => {
                    const option = document.createElement('option');
                    option.value = ciclo.ciclo;
                    option.textContent = `Ciclo ${ciclo.ciclo} (${ciclo.qtd} ausentes)`;
                    elementos.filterCycle.appendChild(option);
                });
            }

            function setupDateFilter() {
                if (state.ciclos.length > 0) {
                    const minDate = state.ciclos.reduce((min, ciclo) => ciclo.date < min ? ciclo.date : min, state.ciclos[0].date);
                    const maxDate = state.ciclos.reduce((max, ciclo) => ciclo.date > max ? ciclo.date : max, state.ciclos[0].date);
                    
                    elementos.filterDate.min = formatDateForInput(minDate);
                    elementos.filterDate.max = formatDateForInput(maxDate);
                }
            }

            function formatDateForInput(date) {
                return date.toISOString().split('T')[0];
            }

            function applyFilters() {
                state.filters = {
                    cycle: elementos.filterCycle.value,
                    date: elementos.filterDate.value ? new Date(elementos.filterDate.value) : null,
                    minAbsent: parseInt(elementos.filterAbsent.value)
                };

                state.filteredCiclos = state.ciclos.filter(ciclo => {
                    const cycleMatch = state.filters.cycle === 'all' || ciclo.ciclo.toString() === state.filters.cycle;
                    const dateMatch = !state.filters.date || (
                        ciclo.date.getFullYear() === state.filters.date.getFullYear() &&
                        ciclo.date.getMonth() === state.filters.date.getMonth() &&
                        ciclo.date.getDate() === state.filters.date.getDate()
                    );
                    const absentMatch = ciclo.dezenas_ausentes.length >= state.filters.minAbsent;
                    
                    return cycleMatch && dateMatch && absentMatch;
                });

                renderCycles();
                updateStats();
            }

            function resetFilters() {
                elementos.filterCycle.value = 'all';
                elementos.filterDate.value = '';
                elementos.filterAbsent.value = '0';
                state.filters = {
                    cycle: 'all',
                    date: null,
                    minAbsent: 0
                };
                state.filteredCiclos = [...state.ciclos];
                renderCycles();
                updateStats();
            }

            function renderCycles() {
                elementos.ciclosContainer.innerHTML = '';
                
                if (state.filteredCiclos.length === 0) {
                    elementos.ciclosContainer.innerHTML = '<p class="no-data">Nenhum ciclo encontrado com os filtros atuais.</p>';
                    return;
                }

                state.filteredCiclos.forEach(ciclo => {
                    const cicloElement = document.createElement('div');
                    cicloElement.className = 'ciclo card';
                    cicloElement.innerHTML = `
                        <h3>Ciclo ${ciclo.ciclo} <small>(Quantidade: ${ciclo.qtd})</small></h3>
                        <p><strong>Dezenas Ausentes (${ciclo.dezenas_ausentes.length}):</strong> 
                            ${ciclo.dezenas_ausentes.map(n => `<span class="numero-sorteado">${n}</span>`).join(' ')}
                        </p>
                        <p><strong>Data estimada:</strong> ${ciclo.date.toLocaleDateString('pt-BR')}</p>
                        <button class="btn-primary gerar-jogo" data-dezenas="${ciclo.dezenas_ausentes.join(',')}">
                            <i class="fas fa-brain"></i> Gerar Jogo Inteligente
                        </button>
                    `;
                    elementos.ciclosContainer.appendChild(cicloElement);
                });

                // Adicionar eventos aos botões gerados dinamicamente
                document.querySelectorAll('.gerar-jogo').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const dezenas = event.target.dataset.dezenas.split(',').map(Number);
                        generateSmartGame(dezenas);
                    });
                });
            }

            function generateSmartGame(dezenasAusentes) {
                if (!dezenasAusentes || dezenasAusentes.length < 15) {
                    showError('Não há dezenas ausentes suficientes para gerar um jogo');
                    return;
                }

                // Embaralha as dezenas ausentes e pega as 15 primeiras
                const shuffled = [...dezenasAusentes].sort(() => Math.random() - 0.5);
                const selectedNumbers = shuffled.slice(0, 15).sort((a, b) => a - b);
                
                state.currentGame = {
                    numbers: selectedNumbers,
                    type: 'inteligente',
                    date: new Date(),
                    source: 'dezenas_ausentes'
                };

                renderCurrentGame();
                elementos.saveGame.disabled = false;
                elementos.clearGame.disabled = false;
            }

            function generateFullRandomGame() {
                // Embaralha todos os números possíveis (1-25) e pega 15
                const shuffled = [...ALL_NUMBERS].sort(() => Math.random() - 0.5);
                const selectedNumbers = shuffled.slice(0, 15).sort((a, b) => a - b);
                
                state.currentGame = {
                    numbers: selectedNumbers,
                    type: 'aleatório',
                    date: new Date(),
                    source: 'full_random'
                };

                renderCurrentGame();
                elementos.saveGame.disabled = false;
                elementos.clearGame.disabled = false;
            }

            function renderCurrentGame() {
                if (!state.currentGame) {
                    elementos.resultado.innerHTML = '<p class="no-data">Nenhum jogo gerado ainda. Selecione um ciclo para gerar um jogo inteligente.</p>';
                    return;
                }

                elementos.resultado.innerHTML = `
                    <h3>Jogo ${state.currentGame.type} <small>(${state.currentGame.date.toLocaleString('pt-BR')})</small></h3>
                    <div class="numeros">
                        ${state.currentGame.numbers.map(n => `<span class="numero-sorteado">${n}</span>`).join(' ')}
                    </div>
                    <p><strong>Tipo:</strong> ${state.currentGame.type === 'inteligente' ? 'Baseado em dezenas ausentes' : 'Aleatório completo'}</p>
                `;
            }

            function saveCurrentGame() {
                if (!state.currentGame) return;
                
                state.savedGames.unshift(state.currentGame);
                if (state.savedGames.length > 50) {
                    state.savedGames = state.savedGames.slice(0, 50);
                }
                
                localStorage.setItem('lotofacilSavedGames', JSON.stringify(state.savedGames));
                renderSavedGames();
                updateStats();
                
                // Mostrar mensagem de sucesso
                const successMsg = document.createElement('div');
                successMsg.className = 'success-message';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Jogo salvo com sucesso no histórico!';
                elementos.resultado.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            }

            function renderSavedGames() {
                if (state.savedGames.length === 0) {
                    elementos.savedGames.innerHTML = '<p class="no-data">Nenhum jogo salvo ainda. Gere e salve jogos para vê-los aqui.</p>';
                    return;
                }

                elementos.savedGames.innerHTML = '';
                state.savedGames.forEach((game, index) => {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'jogo-salvo';
                    gameElement.innerHTML = `
                        <div>
                            <h4>Jogo ${game.type} #${index + 1}</h4>
                            <div class="numeros">
                                ${game.numbers.map(n => `<span class="numero-sorteado">${n}</span>`).join(' ')}
                            </div>
                            <small>${game.date.toLocaleString('pt-BR')}</small>
                        </div>
                        <button class="btn-danger delete-game" data-index="${index}">
                            <i class="far fa-trash-alt"></i>
                        </button>
                    `;
                    elementos.savedGames.appendChild(gameElement);
                });

                // Adicionar eventos aos botões de deletar
                document.querySelectorAll('.delete-game').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const index = parseInt(event.target.closest('button').dataset.index);
                        deleteGame(index);
                    });
                });
            }

            function deleteGame(index) {
                state.savedGames.splice(index, 1);
                localStorage.setItem('lotofacilSavedGames', JSON.stringify(state.savedGames));
                renderSavedGames();
                updateStats();
            }

            function clearCurrentGame() {
                state.currentGame = null;
                renderCurrentGame();
                elementos.saveGame.disabled = true;
                elementos.clearGame.disabled = true;
            }

            function clearHistory() {
                if (confirm('Tem certeza que deseja limpar todo o histórico de jogos salvos?')) {
                    state.savedGames = [];
                    localStorage.removeItem('lotofacilSavedGames');
                    renderSavedGames();
                    updateStats();
                }
            }

            function exportGames() {
                if (state.savedGames.length === 0) {
                    alert('Nenhum jogo para exportar');
                    return;
                }

                const data = {
                    lotofacilGenius: {
                        version: '1.0',
                        generatedAt: new Date().toISOString(),
                        totalGames: state.savedGames.length,
                        games: state.savedGames
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lotofacil-genius-jogos-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function updateStats() {
                elementos.totalCycles.textContent = state.filteredCiclos.length;
                
                if (state.filteredCiclos.length > 0) {
                    const totalAbsent = state.filteredCiclos.reduce((sum, ciclo) => sum + ciclo.dezenas_ausentes.length, 0);
                    const avgAbsent = (totalAbsent / state.filteredCiclos.length).toFixed(1);
                    elementos.avgAbsent.textContent = avgAbsent;
                    
                    const maxCycle = Math.max(...state.filteredCiclos.map(c => c.ciclo));
                    elementos.maxCycle.textContent = maxCycle;
                } else {
                    elementos.avgAbsent.textContent = '0';
                    elementos.maxCycle.textContent = '0';
                }
                
                elementos.totalGames.textContent = state.savedGames.length;
            }

            function showLoading() {
                elementos.loadingCycles.style.display = 'flex';
                elementos.errorCycles.style.display = 'none';
                elementos.ciclosContainer.style.display = 'none';
            }

            function hideLoading() {
                elementos.loadingCycles.style.display = 'none';
                elementos.ciclosContainer.style.display = 'block';
            }

            function showError(message) {
                elementos.errorCycles.style.display = 'block';
                elementos.errorCycles.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            }
        });
    </script>
</body>
</html>
